<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŒœè¬éŠæˆ²</title>
        <link href="css/GameUI.css" rel="stylesheet"/>
        <link href="css/lockUI.css" rel="stylesheet"/>
</head>
<body>
    <div id="game-container"></div>

    <script>
        function getBasename(filepath, ext) {
            const filename = filepath.split('/').pop() || filepath;
            if (ext && filename.endsWith(ext)) {
                return filename.slice(0, -ext.length);
            }
            return filename;
        }

        function getExtension(filepath) {
            const filename = filepath.split('/').pop() || filepath;
            const lastDot = filename.lastIndexOf('.');
            return lastDot === -1 ? '' : filename.slice(lastDot);
        }

        // éŠæˆ²ç‹€æ…‹
        const GameState = {
            INIT: 0,
            PLAYING: 1,
            END: 2
        };

        // éŠæˆ²æ¨¡å¼
        const GameMode = {
            GRole: 1,
            GBrand: 2
        };

        // éŠæˆ²é¡åˆ¥
        const GameCategory = {
            GUESS_CHARACTER: "ç…§ç‰‡çŒœäººç‰©",
            GUESS_CHARACTER_CROPPED: "æ“·å–ç…§ç‰‡çŒœäººç‰©",
            GUESS_CHARACTER_SCENE: "å ´æ™¯çŒœäººç‰©",
            GUESS_WORK_BY_CHARACTER: "äººç‰©çŒœä½œå“",
            GUESS_BRAND: "çŒœå“ç‰Œ",
            GUESS_ORIGINAL_BRAND: "çŒœæ­£ç‰ˆå“ç‰Œ",
            GUESS_PARENT_BRAND: "å­å“ç‰ŒçŒœæºå“ç‰Œ",
            FIND_BRAND_DIFFERENCE: "å“ç‰ŒçŒœä¸åŒ"
        };

        class Game {
            constructor() {
                this.state = GameState.INIT;
                this.currentMode = null;
                this.level = 0;
                this.mainTimer = 0;
                this.levelTimer = 0;
                this.score = { player1: 0, player2: 0 };
                this.imageList = {};
                this.displayedImages = new Set();
                this.lockMode = true; // æ–°å¢ï¼šé–å®šæ¨¡å¼ç‹€æ…‹
                this.lastAction = null; // æ–°å¢ï¼šè¨˜éŒ„æœ€å¾Œæ“ä½œ
                this.lastActionTime = null; // æ–°å¢ï¼šè¨˜éŒ„æœ€å¾Œæ“ä½œæ™‚é–“

                // é¡åˆ¥åˆ°æ–‡ä»¶å¤¾çš„æ˜ å°„
                this.categoryFolders = {
                    [GameCategory.GUESS_CHARACTER]: 'çŒœäººç‰©/ç…§ç‰‡çŒœäººç‰©',
                    [GameCategory.GUESS_CHARACTER_CROPPED]: 'çŒœäººç‰©/æ“·å–ç…§ç‰‡çŒœäººç‰©',
                    [GameCategory.GUESS_CHARACTER_SCENE]: 'çŒœäººç‰©/å ´æ™¯çŒœäººç‰©',
                    [GameCategory.GUESS_WORK_BY_CHARACTER]: 'çŒœäººç‰©/äººç‰©çŒœä½œå“(Bonus)',
                    [GameCategory.GUESS_BRAND]: 'çŒœå“ç‰Œ/çŒœå“ç‰Œ',
                    [GameCategory.GUESS_ORIGINAL_BRAND]: 'çŒœå“ç‰Œ/çŒœæ­£ç‰ˆå“ç‰Œ',
                    [GameCategory.GUESS_PARENT_BRAND]: 'çŒœå“ç‰Œ/å­å“ç‰ŒçŒœæºå“ç‰Œ',
                    [GameCategory.FIND_BRAND_DIFFERENCE]: 'çŒœå“ç‰Œ/å“ç‰ŒçŒœä¸åŒ'
                };

                this.loadImageList();

                this.mainTimerInterval = null;
                this.levelTimeout = null;
                
                this.showAnswerMode = false;
                this.currentQuestionPath = '';
                this.answerButtonEnabled = false;


                // åˆå§‹åŒ–éŠæˆ²
                this.initPage();
            }

            // ç²å–åŸºç¤è·¯å¾‘ - è‡ªå‹•æª¢æ¸¬ç’°å¢ƒ
            // ç²å–åŸºç¤è·¯å¾‘ - è‡ªå‹•æª¢æ¸¬ç’°å¢ƒ
            getBasePath() {
                // æª¢æŸ¥æ˜¯å¦åœ¨ GitHub Pages ç’°å¢ƒ
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;

                if (hostname.includes('github.io')) {
                    // GitHub Pages URL æ ¼å¼: https://username.github.io/repository-name/
                    const pathParts = pathname.split('/').filter(part => part);
                    if (pathParts.length > 0) {
                        // è¿”å› /repository-name
                        return '/' + pathParts[0]; 
                    }
                }
                
                // å¦‚æœåœ¨å­è³‡æ–™å¤¾ä¸­é‹è¡Œ (ä¾‹å¦‚: localhost/game/)
                const lastSlash = pathname.lastIndexOf('/');
                if (lastSlash > 0) {
                    return pathname.substring(0, lastSlash);
                }
                
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒæˆ–æ ¹ç›®éŒ„
                return '';
            }

            async loadImageList() {
                try {
                    const basePath = this.getBasePath();
                    
                    // å˜—è©¦å¤šå€‹å¯èƒ½çš„è·¯å¾‘
                    const possiblePaths = [
                        `${basePath}/js/image-list.json`,
                        `./js/image-list.json`,
                        `js/image-list.json`
                    ];
                    
                    console.log('å˜—è©¦è¼‰å…¥è·¯å¾‘:', possiblePaths);
                    
                    let response = null;
                    let successPath = '';
                    
                    for (const jsonPath of possiblePaths) {
                        try {
                            console.log('å˜—è©¦è·¯å¾‘:', jsonPath);
                            response = await fetch(jsonPath);
                            if (response.ok) {
                                successPath = jsonPath;
                                break;
                            }
                        } catch (e) {
                            console.log(`è·¯å¾‘ ${jsonPath} å¤±æ•—:`, e.message);
                            continue;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw new Error(`æ‰€æœ‰è·¯å¾‘éƒ½ç„¡æ³•è¼‰å…¥ image-list.json`);
                    }
                    
                    console.log('æˆåŠŸè¼‰å…¥è·¯å¾‘:', successPath);
                    
                    const data = await response.json();
                    this.imageList = data;
                    
                    console.log('åœ–ç‰‡åˆ—è¡¨è¼‰å…¥å®Œæˆ:', this.imageList);
                    
                } catch (error) {
                    console.error('è¼‰å…¥åœ–ç‰‡åˆ—è¡¨å¤±æ•—:', error);
                    this.imageList = this.getDefaultImageList();
                    console.log('ä½¿ç”¨é è¨­åœ–ç‰‡åˆ—è¡¨');
                }
            }

            // å‚™ç”¨åœ–ç‰‡åˆ—è¡¨
            getDefaultImageList() {
                const basePath = this.getBasePath();
                return {
                    "çŒœäººç‰©/ç…§ç‰‡çŒœäººç‰©": [
                        `${basePath}/images/default.jpg`,
                        `${basePath}/images/placeholder1.jpg`,
                        `${basePath}/images/placeholder2.jpg`
                    ],
                    "çŒœäººç‰©/æ“·å–ç…§ç‰‡çŒœäººç‰©": [
                        `${basePath}/images/default.jpg`
                    ],
                    "çŒœäººç‰©/å ´æ™¯çŒœäººç‰©": [
                        `${basePath}/images/default.jpg`
                    ],
                    "çŒœä½œå“/äººç‰©çŒœä½œå“": [
                        `${basePath}/images/default.jpg`
                    ],
                    "çŒœå“ç‰Œ/çŒœå“ç‰Œ": [
                        `${basePath}/images/default.jpg`
                    ],
                    "çŒœå“ç‰Œ/çŒœæ­£ç‰ˆå“ç‰Œ": [
                        `${basePath}/images/default.jpg`
                    ],
                    "çŒœå“ç‰Œ/å­å“ç‰ŒçŒœæºå“ç‰Œ": [
                        `${basePath}/images/default.jpg`
                    ],
                    "çŒœå“ç‰Œ/å“ç‰ŒçŒœä¸åŒ": [
                        `${basePath}/images/default.jpg`
                    ]
                };
            }

            getDefaultImage() {
                const basePath = this.getBasePath();
                return `${basePath}/images/default.jpg`;
            }

            getRandomImage(category) {
                const basePath = this.getBasePath();
                const folder = this.categoryFolders[category];
                
                console.log('ç²å–åœ–ç‰‡ - åˆ†é¡:', category);
                console.log('ç²å–åœ–ç‰‡ - è³‡æ–™å¤¾:', folder);
                console.log('ç²å–åœ–ç‰‡ - basePath:', basePath);
                
                if (!folder || !this.imageList[folder]) {
                    console.warn(`æ²’æœ‰æ‰¾åˆ° ${category} é¡åˆ¥çš„åœ–ç‰‡è³‡æ–™`);
                    return this.getDefaultImage();
                }
                
                let availableImages = [];
                if (Array.isArray(this.imageList[folder])) {
                    availableImages = this.imageList[folder];
                } else if (this.imageList[folder].questions) {
                    availableImages = this.imageList[folder].questions;
                } else {
                    console.warn(`${category} é¡åˆ¥çš„åœ–ç‰‡æ ¼å¼ä¸æ­£ç¢º`);
                    return this.getDefaultImage();
                }
                
                if (availableImages.length === 0) {
                    return this.getDefaultImage();
                }
                
                const unshownImages = availableImages.filter(
                    imagePath => !this.displayedImages.has(imagePath)
                );
                
                if (unshownImages.length === 0) {
                    return `${basePath}/images/é¡Œåº«å·²å®Œ.jpg`;
                }
                
                const randomIndex = Math.floor(Math.random() * unshownImages.length);
                const selectedImage = unshownImages[randomIndex];
                
                this.displayedImages.add(selectedImage);
                
                // ä¿®æ­£è·¯å¾‘è™•ç†é‚è¼¯
                let finalPath = selectedImage;
                
                // å¦‚æœåœ–ç‰‡è·¯å¾‘å·²ç¶“æ˜¯çµ•å°è·¯å¾‘ï¼ˆä»¥ / é–‹é ­ï¼‰
                if (selectedImage.startsWith('/')) {
                    finalPath = basePath+selectedImage;
                }
                // å¦‚æœæ˜¯å®Œæ•´ URL
                else if (selectedImage.startsWith('http')) {
                    finalPath = selectedImage;
                }
                // å¦‚æœæ˜¯ç›¸å°è·¯å¾‘ï¼Œéœ€è¦åŠ ä¸Š basePath
                else {
                    // ç¢ºä¿è·¯å¾‘æ­£ç¢ºæ‹¼æ¥
                    if (basePath && !basePath.endsWith('/')) {
                        finalPath = basePath + '/' + selectedImage;
                    } else {
                        finalPath = basePath + selectedImage;
                    }
                }
                
                console.log('æœ€çµ‚åœ–ç‰‡è·¯å¾‘:', finalPath);
                return finalPath;
            }

            preloadImage(url) {
                return new Promise((resolve, reject) => {
                    // æ·»åŠ æ›´å¤šé™¤éŒ¯è³‡è¨Š
                    console.log('é–‹å§‹é è¼‰åœ–ç‰‡:', url);
                    
                    const img = new Image();
                    
                    // è¨­ç½® crossOrigin å±¬æ€§ä»¥è™•ç† CORS å•é¡Œ
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        console.log('âœ… åœ–ç‰‡é è¼‰æˆåŠŸ:', url);
                        resolve(url);
                    };
                    
                    img.onerror = (error) => {
                        console.error('âŒ åœ–ç‰‡é è¼‰å¤±æ•—:', url, error);
                        console.log('éŒ¯èª¤è©³æƒ…:', {
                            src: img.src,
                            complete: img.complete,
                            naturalWidth: img.naturalWidth,
                            naturalHeight: img.naturalHeight
                        });
                        reject(new Error(`ç„¡æ³•è¼‰å…¥åœ–ç‰‡: ${url}`));
                    };
                    
                    // è¨­ç½®è¶…æ™‚
                    setTimeout(() => {
                        if (!img.complete) {
                            console.warn('â±ï¸ åœ–ç‰‡è¼‰å…¥è¶…æ™‚:', url);
                            reject(new Error(`åœ–ç‰‡è¼‰å…¥è¶…æ™‚: ${url}`));
                        }
                    }, 15000); // å¢åŠ åˆ°15ç§’
                    
                    img.src = url;
                });
            }

            clearImageContainer() {
                const imageContainer = document.getElementById('image-container');
                if (imageContainer) {
                    imageContainer.innerHTML = '';
                }
            }

            // åˆå§‹åŒ–é é¢
            initPage() {
            this.state = GameState.INIT;
            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div class="init-container">
                    <h1 style="margin-bottom: 30px; font-size: 32px;">è¿æ–°éŠæˆ²</h1>
                    
                    <!-- Lock/Unlock é–‹é—œ -->
                    <div class="lock-control">
                        <label class="switch">
                            <input type="checkbox" id="lock-toggle" ${this.lockMode ? 'checked' : ''}>
                            <span class="slider round"></span>
                        </label>
                        <span class="lock-label" id="lock-label">
                            ${this.lockMode ? 'ğŸ”’ é–å®šæ¨¡å¼ï¼ˆé–‹å•Ÿï¼‰' : 'ğŸ”“ è§£é–æ¨¡å¼ï¼ˆé—œé–‰ï¼‰'}
                        </span>
                        <div class="lock-description">é˜²æ­¢æ„å¤–è·³é—œï¼Œé–‹å•Ÿæ™‚æœƒç¢ºèªæ˜¯å¦åŠ åˆ†</div>
                    </div>
                    
                    <!-- æ¨¡å¼é¸æ“‡ -->
                    <div class="mode-selection">
                        <button class="mode-btn" data-mode="${GameMode.GRole}">çŒœäººç‰©</button>
                        <button class="mode-btn" data-mode="${GameMode.GBrand}">çŒœå“ç‰Œ</button>
                    </div>
                </div>
            `;
            
            // è¨­ç½® Lock/Unlock é–‹é—œäº‹ä»¶
            const lockToggle = document.getElementById('lock-toggle');
            const lockLabel = document.getElementById('lock-label');
            
            lockToggle.addEventListener('change', (e) => {
                this.lockMode = e.target.checked;
                lockLabel.textContent = this.lockMode 
                    ? 'ğŸ”’ é–å®šæ¨¡å¼ï¼ˆé–‹å•Ÿï¼‰' 
                    : 'ğŸ”“ è§£é–æ¨¡å¼ï¼ˆé—œé–‰ï¼‰';
                console.log(`é–å®šæ¨¡å¼: ${this.lockMode ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
            });
            
            // æ¨¡å¼é¸æ“‡æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    this.currentMode = parseInt(e.target.dataset.mode);
                    this.startGame();
                });
            });
        }

            // é–‹å§‹éŠæˆ²
            startGame() {
                this.state = GameState.PLAYING;
                this.level = 0;
                this.mainTimer = 0;
                this.score = { player1: 0, player2: 0 };
                this.displayedImages.clear(); // é‡ç½®å·²é¡¯ç¤ºåœ–ç‰‡è¨˜éŒ„
                
                // æ ¹æ“šæ¨¡å¼åˆå§‹åŒ–UI
                if (this.currentMode === GameMode.GRole) {
                    this.setupSinglePlayerUI();
                } else {
                    this.setupMultiPlayerUI();
                }
                
                // é–‹å§‹ä¸»è¨ˆæ™‚å™¨
                this.startMainTimer();
                
                // é€²å…¥ç¬¬ä¸€é—œ
                this.executeNextLevel();
            }

            // å–®äººæ¨¡å¼UIè¨­ç½®
            setupSinglePlayerUI() {
                const container = document.getElementById('game-container');
                container.innerHTML = `
                    <div class="game-ui">
                    <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
                    <div class="header-bar">
                        <button class="home-btn" id="home-btn">
                            è¿”å›é¦–é 
                        </button>
                        <div class="header-info">
                            <div class="timer">ç¸½æ™‚é–“: <span id="main-timer">0:00</span></div>
                            <div class="score-display">åˆ†æ•¸: <span id="score">0</span></div>
                        </div>
                    </div>
                    
                    <!-- é—œå¡è³‡è¨Šå€ -->
                    <div class="level-info">
                        <div class="level-title">é—œå¡ä¸»é¡Œ: <span id="current-category"></span></div>
                        <div class="level-timer"><BR>æœ¬é—œæ™‚é–“: <span id="level-timer">10</span></div>
                    </div>
                    
                    <!-- åœ–ç‰‡é¡¯ç¤ºå€ -->
                    <div class="image-container" id="image-container"></div>
                    
                    <!-- æ“ä½œæŒ‰éˆ•å€ -->
                    <div class="action-buttons">
                        <div class="game-controls">
                            <button class="control-btn skip-btn" id="next-btn">
                                ä¸‹ä¸€é—œ
                            </button>
                            <button class="control-btn skip-btn" id="skip-btn">
                                    +1åˆ†é˜(SKIPç”¨)
                            </button>
                        </div>
                        <div class="game-controls" style="visibility:hidden;">
                            <button class="control-btn skip-btn" id="reTime-btn">
                                    æœ‰äººå¹«ä½œç­”ï¼Ÿ(é»æˆ‘æ­¸é›¶)
                            </button>
                        </div>
                        <div class="game-actions">
                            <button class="action-btn answer-btn" id="answer-btn">
                                åŠ  1 åˆ†
                            </button>
                        </div>
                        <div class="game-actions" style="visibility:hidden;">
                            <button class="action-btn bonus-btn" id="bonus-btn">
                                åŠ  2 åˆ†
                            </button>
                        </div>
                    </div>
                </div>
                `;

                const bonusActionDiv = document.getElementById('bonus-btn');
                let isBonus = false;
                
                
                // å¾—åˆ†æŒ‰éˆ•äº‹ä»¶
                document.getElementById('answer-btn').addEventListener('click', () => {
                    this.score.player1 += 1;
                    document.getElementById('score').textContent = this.score.player1;
                    this.recordScoreAction('single');
                    if (this.score.player1 > 40 && isBonus == false) {
                    // å¦‚æœåˆ†æ•¸è¶…é 40ï¼Œé¡¯ç¤ºé¡å¤–åˆ†æ•¸æŒ‰éˆ•
                    bonusActionDiv.style.visibility = 'visible';
                    isBonus = true;
                    }
                });

                document.getElementById('bonus-btn').addEventListener('click', () => {
                    this.score.player1 += 2;
                    document.getElementById('score').textContent = this.score.player1;
                    this.recordScoreAction('single');
                });
                
                // ä¸‹ä¸€é—œæŒ‰éˆ•äº‹ä»¶
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.nextLevel();
                });
                // åŠ æ™‚é–“æŒ‰éˆ•
                document.getElementById('skip-btn').addEventListener('click', () => {
                    this.mainTimer+=60;
                    document.getElementById('main-timer').textContent = this.formatDisplayTime(this.mainTimer);
                });
                
                document.getElementById('reTime-btn').addEventListener('click', () => {
                    this.levelTimer=0;
                    document.getElementById('reTime-btn').style.visibility = 'hidden';
                    document.getElementById('level-timer').textContent = levelTimer+"ç§’";
                });
                
                document.getElementById('home-btn').addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦æ”¾æ£„ç•¶å‰éŠæˆ²è¿”å›é¦–é å—ï¼Ÿ')) {
                    this.initPage();
                    }
                });

                // åˆå§‹åŒ–é¡¯ç¤º
                this.updateLevelInfo();
            }

            // é›™äººæ¨¡å¼UIè¨­ç½®
            setupMultiPlayerUI() {
                const container = document.getElementById('game-container');
                container.innerHTML = `
                    <div class="game-ui multiplayer">
                        <!-- é ‚éƒ¨å°èˆªæ¬„ -->
                        <div class="header-bar">
                            <button class="home-btn" id="home-btn">
                                è¿”å›é¦–é 
                            </button>
                            <div class="timer">ç¸½æ™‚é–“: <span id="main-timer">0:00</span></div>
                        </div>
                        
                        <!-- éšŠä¼åˆ†æ•¸é¡¯ç¤º -->
                        <div class="team-score-display">
                            <div class="team-score red-team">
                                <div class="team-name">ç´…éšŠ</div>
                                <div class="score-value" id="red-score">0</div>
                            </div>
                            <div class="team-score blue-team">
                                <div class="team-name">è—éšŠ</div>
                                <div class="score-value" id="blue-score">0</div>
                            </div>
                        </div>
                        
                        <!-- é—œå¡è³‡è¨Šå€ -->
                        <div class="level-info">
                            <div class="level-title">é—œå¡ä¸»é¡Œ: <span id="current-category"></span></div>
                            <div class="level-timer">æœ¬é—œç›®å‰æ™‚é–“: <span id="level-timer">10</span></div>
                        </div>
                        
                        <!-- åœ–ç‰‡é¡¯ç¤ºå€ - ä½¿ç”¨ä½ çš„CSSé¡åˆ¥ -->
                        <div class="image-container" id="image-container"></div>
                        
                        <!-- æ“ä½œæŒ‰éˆ•å€ -->
                        <div class="action-area">
                            <div class="game-controls">
                                <button class="control-btn skip-btn" id="next-btn">
                                    ä¸‹ä¸€é—œ
                                </button>
                                <button class="control-btn skip-btn" id="skip-btn">
                                    +1åˆ†é˜(SKIPç”¨)
                                </button>
                                <!-- è§£ç­”æŒ‰éˆ• - ä½¿ç”¨ä½ å®šç¾©çš„æ¨£å¼é¡åˆ¥ -->
                                <button class="control-btn answer-btn" id="answer-toggle-btn" style="display: none;">
                                    é¡¯ç¤ºè§£ç­”
                                </button>
                            </div>
                            <div class="team-actions">
                                <button class="team-action-btn red-team" id="red-btn">
                                    ç´…éšŠå¾—åˆ†
                                </button>
                                <button class="team-action-btn blue-team" id="blue-btn">
                                    è—éšŠå¾—åˆ†
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // è¨­ç½®äº‹ä»¶ç›£è½å™¨
                this.setupMultiPlayerEventListeners();
            }

            // æ–°å¢ï¼šå°ˆé–€è¨­ç½®äº‹ä»¶ç›£è½å™¨çš„æ–¹æ³•
            setupMultiPlayerEventListeners() {
                // è§£ç­”æŒ‰éˆ•äº‹ä»¶
                document.getElementById('answer-toggle-btn').addEventListener('click', () => {
                    this.toggleAnswer();
                });
                
                // ç´…éšŠå¾—åˆ†æŒ‰éˆ•äº‹ä»¶ - ä¿®æ­£ï¼šæ·»åŠ  nextLevel()
                document.getElementById('red-btn').addEventListener('click', () => {
                    this.score.player1 += 1;
                    document.getElementById('red-score').textContent = this.score.player1;
                    this.recordScoreAction('red');
                });

                // è—éšŠå¾—åˆ†æŒ‰éˆ•äº‹ä»¶ - ä¿®æ­£ï¼šæ·»åŠ  nextLevel()
                document.getElementById('blue-btn').addEventListener('click', () => {
                    this.score.player2 += 1;
                    document.getElementById('blue-score').textContent = this.score.player2;
                    this.recordScoreAction('blue');
                });
                
                // ä¸‹ä¸€é—œæŒ‰éˆ•äº‹ä»¶
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.nextLevel();
                });
                
                // åŠ æ™‚é–“æŒ‰éˆ•
                document.getElementById('skip-btn').addEventListener('click', () => {
                    this.mainTimer += 60;
                    document.getElementById('main-timer').textContent = this.formatDisplayTime(this.mainTimer);
                });
                
                // è¿”å›é¦–é æŒ‰éˆ•äº‹ä»¶
                document.getElementById('home-btn').addEventListener('click', () => {
                    if (confirm('ç¢ºå®šè¦çµæŸç•¶å‰éŠæˆ²è¿”å›é¦–é å—ï¼Ÿ')) {
                        this.initPage();
                    }
                });
            }

            updateLevelInfo() {
                const category = this.getCurrentCategory();
                document.getElementById('current-category').textContent = this.getCategoryName(category);
                document.getElementById('level-timer').textContent = this.levelTimer;
            }

            // é–‹å§‹ä¸»è¨ˆæ™‚å™¨
            startMainTimer() {
                // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
                if (this.mainTimerInterval) {
                    clearInterval(this.mainTimerInterval);
                }
                
                this.mainTimerInterval = setInterval(() => {
                    this.mainTimer += 1;
                    document.getElementById('main-timer').textContent = this.formatDisplayTime(this.mainTimer);
                    
                    // æª¢æŸ¥éŠæˆ²çµæŸæ¢ä»¶
                    if ((this.currentMode === GameMode.GRole && this.mainTimer >= 720) || // 12åˆ†é˜
                        (this.currentMode === GameMode.GBrand && this.mainTimer >= 1140)) { // 19åˆ†é˜
                        this.endGame();
                    }
                }, 1000);
            }

            formatDisplayTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // ä¸‹ä¸€é—œ
            nextLevel() {
                // æª¢æŸ¥é–å®šæ¨¡å¼ä¸¦ç¢ºèªæ˜¯å¦è·³é—œ
                if (this.lockMode && !this.checkScoreAdded()) {
                    this.showSkipConfirmation();
                    return; // ä¸åŸ·è¡Œè·³é—œ
                }
                
                // æ­£å¸¸åŸ·è¡Œè·³é—œé‚è¼¯
                this.executeNextLevel();
            }

            executeNextLevel() {
                this.showAnswerMode = false;
                this.updateAnswerButton();

                clearTimeout(this.levelTimeout);
                clearInterval(this.levelTimerInterval);
                
                const category = this.getCurrentCategory();
                this.level++;
                this.currentQuestionPath = this.getRandomImage(category);
                this.showLevelImage(category);
                this.startLevelTimer();
                this.updateLevelInfo();
                document.getElementById('reTime-btn').style.visibility = 'hidden';


                this.checkAndEnableAnswerButton(category);
                
                // é‡ç½®æœ€å¾Œæ“ä½œè¨˜éŒ„
                this.lastAction = null;
            }

            // æª¢æŸ¥æ˜¯å¦å·²åŠ åˆ†
                checkScoreAdded() {
                    const currentTime = Date.now();
                    
                    // å¦‚æœåœ¨æœ€è¿‘3ç§’å…§æœ‰åŠ åˆ†æ“ä½œï¼Œèªç‚ºå·²åŠ åˆ†
                    if (this.lastAction === 'score' && (currentTime - this.lastActionTime) < 3000) {
                        return true;
                    }
                    
                    // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦æœ‰è®ŠåŒ–ï¼ˆæ¯”è¼ƒè¤‡é›œï¼Œéœ€è¦è¨˜éŒ„ä¸Šä¸€å€‹ç‹€æ…‹ï¼‰
                    return false;
                }

                showSkipConfirmation() {
                    // å‰µå»ºè‡ªå®šç¾©ç¢ºèªå°è©±æ¡†
                    const confirmDialog = document.createElement('div');
                    confirmDialog.className = 'skip-confirm-dialog';
                    confirmDialog.innerHTML = `
                        <div class="confirm-content">
                            <h3>âš ï¸ ç¢ºèªè·³é—œ</h3>
                            <p>æ‚¨å°šæœªç‚ºä»»ä½•éšŠä¼åŠ åˆ†ï¼Œç¢ºå®šè¦è·³éæœ¬é—œå—ï¼Ÿ</p>
                            <div class="confirm-buttons">
                                <button class="confirm-btn cancel-btn">å–æ¶ˆ</button>
                                <button class="confirm-btn continue-btn">ç¹¼çºŒè·³é—œ</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(confirmDialog);
                    
                    // æŒ‰éˆ•äº‹ä»¶
                    confirmDialog.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(confirmDialog);
                    });
                    
                    confirmDialog.querySelector('.continue-btn').addEventListener('click', () => {
                        document.body.removeChild(confirmDialog);
                        this.executeNextLevel();
                    });
                    
                }

                // è¨˜éŒ„åŠ åˆ†æ“ä½œ
                recordScoreAction(team) {
                    this.lastAction = 'score';
                    this.lastActionTime = Date.now();
                    console.log(`${team === 'red' ? 'ç´…éšŠ' : 'è—éšŠ'} åŠ åˆ†ï¼Œæ™‚é–“: ${new Date().toLocaleTimeString()}`);
                }



             getCategoryName(category) {
                const names = {
                    [GameCategory.GUESS_CHARACTER]: 'ç…§ç‰‡çŒœäººç‰©',
                    [GameCategory.GUESS_CHARACTER_CROPPED]: 'æ“·å–ç…§ç‰‡çŒœäººç‰©',
                    [GameCategory.GUESS_CHARACTER_SCENE]: 'å ´æ™¯çŒœäººç‰©',
                    [GameCategory.GUESS_WORK_BY_CHARACTER]: 'äººç‰©çŒœä½œå“',
                    [GameCategory.GUESS_BRAND]: 'çŒœå“ç‰Œ',
                    [GameCategory.GUESS_ORIGINAL_BRAND]: 'çŒœæ­£ç‰ˆå“ç‰Œ',
                    [GameCategory.GUESS_PARENT_BRAND]: 'å­å“ç‰ŒçŒœæºå“ç‰Œ',
                    [GameCategory.FIND_BRAND_DIFFERENCE]: 'å“ç‰ŒçŒœä¸åŒ'
                };
                return names[category] || 'æœªçŸ¥ä¸»é¡Œ';
            }

            condition(mainTime,score){
                if(this.currentMode === GameMode.GRole){
                    return ((this.mainTimer < mainTime) && (this.score.player1 < score))?true:false;
                }
                else
                {
                    return ((this.mainTimer < mainTime))?true:false;
                }
            }

            // å¾è·¯å¾‘ç²å–åˆ†é¡
            getCategoryFromPath(imagePath) {
                // æ ¹æ“šæ‚¨çš„è·¯å¾‘çµæ§‹ä¾†è§£æåˆ†é¡
                // ä¾‹å¦‚: /images/game/çŒœäººç‰©/ç…§ç‰‡çŒœäººç‰©/rick.jpg â†’ çŒœäººç‰©/ç…§ç‰‡çŒœäººç‰©
                const pathParts = imagePath.split('/');
                const gameIndex = pathParts.indexOf('game');
                
                if (gameIndex !== -1 && pathParts.length > gameIndex + 2) {
                    return pathParts.slice(gameIndex + 1, gameIndex + 3).join('/');
                }
                
                return null;
            }

            // ç²å–ç•¶å‰é¡Œç›®é¡åˆ¥
             getCurrentCategory() {
                if (this.currentMode === GameMode.GRole) {
                    if (this.condition(360,21))
                        return GameCategory.GUESS_CHARACTER; // 6åˆ†é˜
                    else if (this.condition(540,31))
                        return GameCategory.GUESS_CHARACTER_CROPPED; // 9åˆ†é˜å’Œ30åˆ†
                    else if (this.condition(720,41))
                        return GameCategory.GUESS_CHARACTER_SCENE; // 12åˆ†é˜å’Œ40åˆ†
                    else
                        return GameCategory.GUESS_WORK_BY_CHARACTER; // 45åˆ†
                } else {
                    if (this.condition(420,'none')) return GameCategory.GUESS_BRAND; // 7åˆ†é˜
                    else if (this.condition(840,'none') ) return GameCategory.GUESS_ORIGINAL_BRAND; // 14åˆ†é˜
                    else if (this.condition(1020,'none')) return GameCategory.GUESS_PARENT_BRAND; // 17åˆ†é˜
                    return GameCategory.FIND_BRAND_DIFFERENCE;
                }
                
                return GameCategory.GUESS_CHARACTER;
            }            

            // æ›´æ–°è§£ç­”æŒ‰éˆ•ç‹€æ…‹
            updateAnswerButton() {
                const answerBtn = document.getElementById('answer-toggle-btn');
                if (answerBtn && this.answerButtonEnabled) {
                    if (this.showAnswerMode) {
                        answerBtn.textContent = 'è¿”å›é¡Œç›®';
                        answerBtn.classList.add('active');
                    } else {
                        answerBtn.textContent = 'é¡¯ç¤ºè§£ç­”';
                        answerBtn.classList.remove('active');
                    }
                    console.log('æŒ‰éˆ•æ–‡å­—æ›´æ–°ç‚º:', answerBtn.textContent);
                }
            }

            // åœ¨é©ç•¶çš„æ™‚æ©Ÿå•Ÿç”¨è§£ç­”æŒ‰éˆ•ï¼ˆä¾‹å¦‚ï¼šç‰¹å®šé—œå¡æˆ–æ™‚é–“ï¼‰
            enableAnswerButton(enable) {
                const answerBtn = document.getElementById('answer-toggle-btn'); // ä¿®æ­£ID
                if (answerBtn) {
                    this.answerButtonEnabled = enable;
                    answerBtn.style.display = enable ? 'block' : 'none';
                    
                    if (!enable) {
                        this.showAnswerMode = false;
                        this.showQuestionImage();
                    }
                }
            }

            // æª¢æŸ¥ä¸¦å•Ÿç”¨è§£ç­”æŒ‰éˆ•
            checkAndEnableAnswerButton(category) {
                // åªåœ¨ç‰¹å®šé—œå¡é¡å‹å•Ÿç”¨è§£ç­”æŒ‰éˆ•
                const answerEnabledCategories = [
                    GameCategory.GUESS_ORIGINAL_BRAND,
                    GameCategory.GUESS_PARENT_BRAND,
                    GameCategory.FIND_BRAND_DIFFERENCE
                ];
                
                const enableAnswer = answerEnabledCategories.includes(category);
                this.enableAnswerButton(enableAnswer);
            }

            // åˆ‡æ›è§£ç­”é¡¯ç¤º
            toggleAnswer() {
                if (!this.answerButtonEnabled) {
                    console.log('è§£ç­”æŒ‰éˆ•æœªå•Ÿç”¨');
                    return;
                }
                
                console.log('åˆ‡æ›å‰ç‹€æ…‹:', this.showAnswerMode ? 'è§£ç­”æ¨¡å¼' : 'é¡Œç›®æ¨¡å¼');
                
                // åˆ‡æ›ç‹€æ…‹
                this.showAnswerMode = !this.showAnswerMode;
                
                // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºå…§å®¹
                if (this.showAnswerMode) {
                    this.showAnswerImage();
                } else {
                    this.showQuestionImage();
                }
                
                // æ›´æ–°æŒ‰éˆ•
                this.updateAnswerButton();
                
                console.log('åˆ‡æ›å¾Œç‹€æ…‹:', this.showAnswerMode ? 'è§£ç­”æ¨¡å¼' : 'é¡Œç›®æ¨¡å¼');
            }

            // é¡¯ç¤ºè§£ç­”åœ–ç‰‡
           async showAnswerImage() {
                const imageContainer = document.getElementById('image-container');
                
                console.log('å˜—è©¦é¡¯ç¤ºè§£ç­”ï¼Œç•¶å‰é¡Œç›®è·¯å¾‘:', this.currentQuestionPath);
                
                try {
                    const answerPath = this.getAnswerPath(this.currentQuestionPath);
                    
                    if (answerPath) {
                        console.log('æº–å‚™è¼‰å…¥è§£ç­”åœ–ç‰‡:', answerPath);
                        
                        // é è¼‰è§£ç­”åœ–ç‰‡
                        await this.preloadImage(answerPath);
                        
                        // å®Œå…¨æŒ‰ç…§ä½ çš„CSSçµæ§‹ - åœ–ç‰‡ + çµ•å°å®šä½çš„æ¨™ç±¤
                        imageContainer.innerHTML = `
                            <img src="${answerPath}" 
                                alt="è§£ç­”åœ–ç‰‡" 
                                onerror="this.src='${this.getDefaultImage()}';">
                            <div style="position: absolute; top: 10px; left: 10px; background: #4CAF50; color: white; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                è§£ç­”
                            </div>
                        `;
                        
                        console.log('è§£ç­”åœ–ç‰‡é¡¯ç¤ºæˆåŠŸ');
                        
                    } else {
                        console.log('æ²’æœ‰æ‰¾åˆ°è§£ç­”åœ–ç‰‡');
                        // ä¿æŒå®¹å™¨çµæ§‹ï¼Œåªæ˜¯é¡¯ç¤ºæ–‡å­—è¨Šæ¯
                        imageContainer.innerHTML = `
                            <div class="no-answer">æœ¬é¡Œç›®æ²’æœ‰æä¾›è§£ç­”åœ–ç‰‡</div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('è¼‰å…¥è§£ç­”å¤±æ•—:', error);
                    imageContainer.innerHTML = `
                        <div class="error">è¼‰å…¥è§£ç­”æ™‚ç™¼ç”ŸéŒ¯èª¤</div>
                    `;
                }
            }

            debugAnswerSystem() {
                console.log('=== è§£ç­”ç³»çµ±é™¤éŒ¯è³‡è¨Š ===');
                console.log('ç•¶å‰é¡Œç›®è·¯å¾‘:', this.currentQuestionPath);
                console.log('ç•¶å‰åˆ†é¡:', this.getCurrentCategory());
                console.log('å°æ‡‰è³‡æ–™å¤¾:', this.categoryFolders[this.getCurrentCategory()]);
                
                const folder = this.categoryFolders[this.getCurrentCategory()];
                if (folder && this.imageList[folder]) {
                    console.log('è³‡æ–™å¤¾å…§å®¹:', this.imageList[folder]);
                    
                    if (this.imageList[folder].answers) {
                        console.log('å¯ç”¨è§£ç­”:', Object.keys(this.imageList[folder].answers));
                    } else {
                        console.log('è©²è³‡æ–™å¤¾æ²’æœ‰è§£ç­”');
                    }
                } else {
                    console.log('æ‰¾ä¸åˆ°è³‡æ–™å¤¾æˆ–è³‡æ–™å¤¾å…§å®¹');
                }
                
                // æ¸¬è©¦è·¯å¾‘è§£æ
                if (this.currentQuestionPath) {
                    const extension = getExtension(this.currentQuestionPath);
                    const fileName = getBasename(this.currentQuestionPath, extension);
                    console.log('è§£æçµæœ - å‰¯æª”å:', extension, 'æª”å:', fileName);
                    
                    const answerPath = this.getAnswerPath(this.currentQuestionPath);
                    console.log('è§£ç­”è·¯å¾‘:', answerPath);
                }
                console.log('========================');
            }

            // é¡¯ç¤ºé¡Œç›®åœ–ç‰‡
            showQuestionImage() {
                const imageContainer = document.getElementById('image-container');
                const category = this.getCurrentCategory();
                
                // ç›´æ¥æ”¾åœ–ç‰‡ï¼Œç¬¦åˆä½ çš„CSSçµæ§‹
                imageContainer.innerHTML = `
                    <img src="${this.currentQuestionPath}" 
                        alt="${this.getCategoryName(category)}" 
                        onerror="this.src='${this.getDefaultImage()}';">
                `;
                
                console.log('é¡¯ç¤ºé¡Œç›®åœ–ç‰‡:', this.currentQuestionPath);
            }

             getAnswerPath(questionPath) {
                try {
                    console.log('é–‹å§‹å°‹æ‰¾è§£ç­”åœ–ç‰‡ï¼Œé¡Œç›®è·¯å¾‘:', questionPath);
                    
                    // ä½¿ç”¨ç€è¦½å™¨ç›¸å®¹çš„æ–¹å¼ç²å–æª”æ¡ˆåç¨±
                    const extension = getExtension(questionPath);
                    const fileName = getBasename(questionPath, extension);
                    
                    console.log('æå–çš„æª”æ¡ˆåç¨±:', fileName);
                    
                    // ç²å–ç•¶å‰åˆ†é¡å°æ‡‰çš„è³‡æ–™å¤¾
                    const currentCategory = this.getCurrentCategory();
                    const folder = this.categoryFolders[currentCategory];
                    
                    console.log('ç•¶å‰åˆ†é¡:', currentCategory);
                    console.log('å°æ‡‰è³‡æ–™å¤¾:', folder);
                    
                    // æª¢æŸ¥è©²è³‡æ–™å¤¾æ˜¯å¦æœ‰è§£ç­”
                    if (!folder || !this.imageList[folder]) {
                        console.warn('æ‰¾ä¸åˆ°å°æ‡‰çš„è³‡æ–™å¤¾:', folder);
                        return null;
                    }
                    
                    const folderData = this.imageList[folder];
                    console.log('è³‡æ–™å¤¾å…§å®¹:', folderData);
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ answers ç‰©ä»¶
                    if (!folderData.answers || typeof folderData.answers !== 'object') {
                        console.warn('è©²è³‡æ–™å¤¾æ²’æœ‰è§£ç­”åœ–ç‰‡');
                        return null;
                    }
                    
                    // å°‹æ‰¾å°æ‡‰çš„è§£ç­”
                    const answerPath = this.getBasePath()+'/' + folderData.answers[fileName];
                    console.log('æ‰¾åˆ°çš„è§£ç­”è·¯å¾‘:', answerPath);
                    
                    if (!answerPath) {
                        console.warn(`æ‰¾ä¸åˆ°æª”æ¡ˆ ${fileName} çš„è§£ç­”`);
                        console.log('å¯ç”¨çš„è§£ç­”åˆ—è¡¨:', Object.keys(folderData.answers));
                        return null;
                    }
                    
                    return answerPath;
                    
                } catch (error) {
                    console.error('ç²å–è§£ç­”è·¯å¾‘æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    return null;
                }
            }
                    

            // é¡¯ç¤ºé—œå¡åœ–ç‰‡
            async showLevelImage(category) {
                const imageContainer = document.getElementById('image-container');
                
                // è¼‰å…¥æç¤º - ä½¿ç”¨ä½ CSSä¸­å®šç¾©çš„loadingæ¨£å¼
                imageContainer.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
                
                try {
                    const imagePath = this.getRandomImage(category);
                    this.currentQuestionPath = imagePath; // è¨­ç½®ç•¶å‰å•é¡Œè·¯å¾‘
                    
                    console.log('å˜—è©¦è¼‰å…¥åœ–ç‰‡:', imagePath);
                    
                    // é è¼‰åœ–ç‰‡
                    await this.preloadImage(imagePath);
                    
                    // é¡¯ç¤ºåœ–ç‰‡ - ç›´æ¥æ”¾imgæ¨™ç±¤
                    imageContainer.innerHTML = `
                        <img src="${imagePath}" 
                            alt="${this.getCategoryName(category)}" 
                            onerror="this.src='${this.getDefaultImage()}';">
                    `;
                    
                    console.log('åœ–ç‰‡é¡¯ç¤ºæˆåŠŸ');
                    
                } catch (error) {
                    console.error('é¡¯ç¤ºåœ–ç‰‡å¤±æ•—:', error);
                    
                    // éŒ¯èª¤é¡¯ç¤º - ä½¿ç”¨ä½ CSSä¸­å®šç¾©çš„erroræ¨£å¼
                    imageContainer.innerHTML = `
                        <div class="error">åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>
                        <img src="${this.getDefaultImage()}" alt="é è¨­åœ–ç‰‡">
                    `;
                }
            }

            // é–‹å§‹é—œå¡è¨ˆæ™‚å™¨
            startLevelTimer() {
                this.levelTimer = 0;
                clearTimeout(this.levelTimeout);
                
                // æ›´æ–°æœ¬é—œæ™‚é–“é¡¯ç¤º
                const updateLevelTimer = () => {
                    this.levelTimer += 1;
                    var iSretime =false;
                    const reTimeBTN = document.getElementById('reTime-btn');

                    if(this.levelTimer<=10){
                        document.getElementById('level-timer').textContent = this.levelTimer+"ç§’";
                        if(iSretime==true){reTimeBTN.style.visibility = 'hidden';iSretime=false}
                    }
                    else{
                        document.getElementById('level-timer').textContent = this.levelTimer+"ç§’  æ™‚é–“åˆ°";
                        if(iSretime==false){reTimeBTN.style.visibility = 'visible';iSretime=true}
                    }
                };
                
                // æ¯ç§’æ›´æ–°æœ¬é—œæ™‚é–“
                this.levelTimerInterval = setInterval(updateLevelTimer, 1000);
            }

            // çµæŸéŠæˆ²
            endGame() {
                this.state = GameState.END;
                clearInterval(this.mainTimerInterval);
                clearTimeout(this.levelTimeout);
                
                // é¡¯ç¤ºçµæŸé é¢
                this.showEndPage();
            }

            // é¡¯ç¤ºçµæŸé é¢
            showEndPage() {
                const container = document.getElementById('game-container');
                if (this.currentMode === GameMode.GRole) {
                    container.innerHTML = `
                        <div class="end-screen">
                            <h2>éŠæˆ²çµæŸ</h2>
                            <p>ä½ çš„åˆ†æ•¸: ${this.score.player1}</p>
                            <button id="restart-btn">å†ç©ä¸€æ¬¡</button>
                            <button id="home-btn">è¿”å›é¦–é </button>
                        </div>
                    `;
                } else {
                    const winner = this.score.player1 > this.score.player2 ? "ç´…éšŠ" : 
                                 this.score.player1 < this.score.player2 ? "è—éšŠ" : "å¹³å±€";
                    
                    container.innerHTML = `
                        <div class="end-screen">
                            <h2>éŠæˆ²çµæŸ</h2>
                            <p>ç´…éšŠåˆ†æ•¸: ${this.score.player1}</p>
                            <p>è—éšŠåˆ†æ•¸: ${this.score.player2}</p>
                            <p style="font-weight: bold; font-size: 28px;">${winner}ç²å‹!</p>
                            <button id="restart-btn">å†ç©ä¸€æ¬¡</button>
                            <button id="home-btn">è¿”å›é¦–é </button>
                        </div>
                    `;
                }
                
                document.getElementById('restart-btn').addEventListener('click', () => {
                    this.startGame();
                });
                
                document.getElementById('home-btn').addEventListener('click', () => {
                    this.initPage();
                });
            }
        }

        // åˆå§‹åŒ–éŠæˆ²
        document.addEventListener('DOMContentLoaded', () => {
            const game = new Game();
        });
    </script>
</body>
</html>

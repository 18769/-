<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>猜謎遊戲</title>
        <link href="css/GameUI.css" rel="stylesheet"/>
        <link href="css/lockUI.css" rel="stylesheet"/>
</head>
<body>
    <div id="game-container"></div>

    <script>
        function getBasename(filepath, ext) {
            const filename = filepath.split('/').pop() || filepath;
            if (ext && filename.endsWith(ext)) {
                return filename.slice(0, -ext.length);
            }
            return filename;
        }

        function getExtension(filepath) {
            const filename = filepath.split('/').pop() || filepath;
            const lastDot = filename.lastIndexOf('.');
            return lastDot === -1 ? '' : filename.slice(lastDot);
        }

        // 遊戲狀態
        const GameState = {
            INIT: 0,
            PLAYING: 1,
            END: 2
        };

        // 遊戲模式
        const GameMode = {
            GRole: 1,
            GBrand: 2
        };

        // 遊戲類別
        const GameCategory = {
            GUESS_CHARACTER: "照片猜人物",
            GUESS_CHARACTER_CROPPED: "擷取照片猜人物",
            GUESS_CHARACTER_SCENE: "場景猜人物",
            GUESS_WORK_BY_CHARACTER: "人物猜作品",
            GUESS_BRAND: "猜品牌",
            GUESS_ORIGINAL_BRAND: "猜正版品牌",
            GUESS_PARENT_BRAND: "子品牌猜源品牌",
            FIND_BRAND_DIFFERENCE: "品牌猜不同"
        };

        class Game {
            constructor() {
                this.state = GameState.INIT;
                this.currentMode = null;
                this.level = 0;
                this.mainTimer = 0;
                this.levelTimer = 0;
                this.score = { player1: 0, player2: 0 };
                this.imageList = {};
                this.displayedImages = new Set();
                this.lockMode = true; // 新增：鎖定模式狀態
                this.lastAction = null; // 新增：記錄最後操作
                this.lastActionTime = null; // 新增：記錄最後操作時間

                // 類別到文件夾的映射
                this.categoryFolders = {
                    [GameCategory.GUESS_CHARACTER]: '猜人物/照片猜人物',
                    [GameCategory.GUESS_CHARACTER_CROPPED]: '猜人物/擷取照片猜人物',
                    [GameCategory.GUESS_CHARACTER_SCENE]: '猜人物/場景猜人物',
                    [GameCategory.GUESS_WORK_BY_CHARACTER]: '猜人物/人物猜作品(Bonus)',
                    [GameCategory.GUESS_BRAND]: '猜品牌/猜品牌',
                    [GameCategory.GUESS_ORIGINAL_BRAND]: '猜品牌/猜正版品牌',
                    [GameCategory.GUESS_PARENT_BRAND]: '猜品牌/子品牌猜源品牌',
                    [GameCategory.FIND_BRAND_DIFFERENCE]: '猜品牌/品牌猜不同'
                };

                this.loadImageList();

                this.mainTimerInterval = null;
                this.levelTimeout = null;
                
                this.showAnswerMode = false;
                this.currentQuestionPath = '';
                this.answerButtonEnabled = false;


                // 初始化遊戲
                this.initPage();
            }

            // 獲取基礎路徑 - 自動檢測環境
            // 獲取基礎路徑 - 自動檢測環境
            getBasePath() {
                // 檢查是否在 GitHub Pages 環境
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;

                if (hostname.includes('github.io')) {
                    // GitHub Pages URL 格式: https://username.github.io/repository-name/
                    const pathParts = pathname.split('/').filter(part => part);
                    if (pathParts.length > 0) {
                        // 返回 /repository-name
                        return '/' + pathParts[0]; 
                    }
                }
                
                // 如果在子資料夾中運行 (例如: localhost/game/)
                const lastSlash = pathname.lastIndexOf('/');
                if (lastSlash > 0) {
                    return pathname.substring(0, lastSlash);
                }
                
                // 本地開發環境或根目錄
                return '';
            }

            async loadImageList() {
                try {
                    const basePath = this.getBasePath();
                    
                    // 嘗試多個可能的路徑
                    const possiblePaths = [
                        `${basePath}/js/image-list.json`,
                        `./js/image-list.json`,
                        `js/image-list.json`
                    ];
                    
                    console.log('嘗試載入路徑:', possiblePaths);
                    
                    let response = null;
                    let successPath = '';
                    
                    for (const jsonPath of possiblePaths) {
                        try {
                            console.log('嘗試路徑:', jsonPath);
                            response = await fetch(jsonPath);
                            if (response.ok) {
                                successPath = jsonPath;
                                break;
                            }
                        } catch (e) {
                            console.log(`路徑 ${jsonPath} 失敗:`, e.message);
                            continue;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw new Error(`所有路徑都無法載入 image-list.json`);
                    }
                    
                    console.log('成功載入路徑:', successPath);
                    
                    const data = await response.json();
                    this.imageList = data;
                    
                    console.log('圖片列表載入完成:', this.imageList);
                    
                } catch (error) {
                    console.error('載入圖片列表失敗:', error);
                    this.imageList = this.getDefaultImageList();
                    console.log('使用預設圖片列表');
                }
            }

            // 備用圖片列表
            getDefaultImageList() {
                const basePath = this.getBasePath();
                return {
                    "猜人物/照片猜人物": [
                        `${basePath}/images/default.jpg`,
                        `${basePath}/images/placeholder1.jpg`,
                        `${basePath}/images/placeholder2.jpg`
                    ],
                    "猜人物/擷取照片猜人物": [
                        `${basePath}/images/default.jpg`
                    ],
                    "猜人物/場景猜人物": [
                        `${basePath}/images/default.jpg`
                    ],
                    "猜作品/人物猜作品": [
                        `${basePath}/images/default.jpg`
                    ],
                    "猜品牌/猜品牌": [
                        `${basePath}/images/default.jpg`
                    ],
                    "猜品牌/猜正版品牌": [
                        `${basePath}/images/default.jpg`
                    ],
                    "猜品牌/子品牌猜源品牌": [
                        `${basePath}/images/default.jpg`
                    ],
                    "猜品牌/品牌猜不同": [
                        `${basePath}/images/default.jpg`
                    ]
                };
            }

            getDefaultImage() {
                const basePath = this.getBasePath();
                return `${basePath}/images/default.jpg`;
            }

            getRandomImage(category) {
                const basePath = this.getBasePath();
                const folder = this.categoryFolders[category];
                
                console.log('獲取圖片 - 分類:', category);
                console.log('獲取圖片 - 資料夾:', folder);
                console.log('獲取圖片 - basePath:', basePath);
                
                if (!folder || !this.imageList[folder]) {
                    console.warn(`沒有找到 ${category} 類別的圖片資料`);
                    return this.getDefaultImage();
                }
                
                let availableImages = [];
                if (Array.isArray(this.imageList[folder])) {
                    availableImages = this.imageList[folder];
                } else if (this.imageList[folder].questions) {
                    availableImages = this.imageList[folder].questions;
                } else {
                    console.warn(`${category} 類別的圖片格式不正確`);
                    return this.getDefaultImage();
                }
                
                if (availableImages.length === 0) {
                    return this.getDefaultImage();
                }
                
                const unshownImages = availableImages.filter(
                    imagePath => !this.displayedImages.has(imagePath)
                );
                
                if (unshownImages.length === 0) {
                    return `${basePath}/images/題庫已完.jpg`;
                }
                
                const randomIndex = Math.floor(Math.random() * unshownImages.length);
                const selectedImage = unshownImages[randomIndex];
                
                this.displayedImages.add(selectedImage);
                
                // 修正路徑處理邏輯
                let finalPath = selectedImage;
                
                // 如果圖片路徑已經是絕對路徑（以 / 開頭）
                if (selectedImage.startsWith('/')) {
                    finalPath = basePath+selectedImage;
                }
                // 如果是完整 URL
                else if (selectedImage.startsWith('http')) {
                    finalPath = selectedImage;
                }
                // 如果是相對路徑，需要加上 basePath
                else {
                    // 確保路徑正確拼接
                    if (basePath && !basePath.endsWith('/')) {
                        finalPath = basePath + '/' + selectedImage;
                    } else {
                        finalPath = basePath + selectedImage;
                    }
                }
                
                console.log('最終圖片路徑:', finalPath);
                return finalPath;
            }

            preloadImage(url) {
                return new Promise((resolve, reject) => {
                    // 添加更多除錯資訊
                    console.log('開始預載圖片:', url);
                    
                    const img = new Image();
                    
                    // 設置 crossOrigin 屬性以處理 CORS 問題
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        console.log('✅ 圖片預載成功:', url);
                        resolve(url);
                    };
                    
                    img.onerror = (error) => {
                        console.error('❌ 圖片預載失敗:', url, error);
                        console.log('錯誤詳情:', {
                            src: img.src,
                            complete: img.complete,
                            naturalWidth: img.naturalWidth,
                            naturalHeight: img.naturalHeight
                        });
                        reject(new Error(`無法載入圖片: ${url}`));
                    };
                    
                    // 設置超時
                    setTimeout(() => {
                        if (!img.complete) {
                            console.warn('⏱️ 圖片載入超時:', url);
                            reject(new Error(`圖片載入超時: ${url}`));
                        }
                    }, 15000); // 增加到15秒
                    
                    img.src = url;
                });
            }

            clearImageContainer() {
                const imageContainer = document.getElementById('image-container');
                if (imageContainer) {
                    imageContainer.innerHTML = '';
                }
            }

            // 初始化頁面
            initPage() {
            this.state = GameState.INIT;
            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div class="init-container">
                    <h1 style="margin-bottom: 30px; font-size: 32px;">迎新遊戲</h1>
                    
                    <!-- Lock/Unlock 開關 -->
                    <div class="lock-control">
                        <label class="switch">
                            <input type="checkbox" id="lock-toggle" ${this.lockMode ? 'checked' : ''}>
                            <span class="slider round"></span>
                        </label>
                        <span class="lock-label" id="lock-label">
                            ${this.lockMode ? '🔒 鎖定模式（開啟）' : '🔓 解鎖模式（關閉）'}
                        </span>
                        <div class="lock-description">防止意外跳關，開啟時會確認是否加分</div>
                    </div>
                    
                    <!-- 模式選擇 -->
                    <div class="mode-selection">
                        <button class="mode-btn" data-mode="${GameMode.GRole}">猜人物</button>
                        <button class="mode-btn" data-mode="${GameMode.GBrand}">猜品牌</button>
                    </div>
                </div>
            `;
            
            // 設置 Lock/Unlock 開關事件
            const lockToggle = document.getElementById('lock-toggle');
            const lockLabel = document.getElementById('lock-label');
            
            lockToggle.addEventListener('change', (e) => {
                this.lockMode = e.target.checked;
                lockLabel.textContent = this.lockMode 
                    ? '🔒 鎖定模式（開啟）' 
                    : '🔓 解鎖模式（關閉）';
                console.log(`鎖定模式: ${this.lockMode ? '開啟' : '關閉'}`);
            });
            
            // 模式選擇按鈕事件
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    this.currentMode = parseInt(e.target.dataset.mode);
                    this.startGame();
                });
            });
        }

            // 開始遊戲
            startGame() {
                this.state = GameState.PLAYING;
                this.level = 0;
                this.mainTimer = 0;
                this.score = { player1: 0, player2: 0 };
                this.displayedImages.clear(); // 重置已顯示圖片記錄
                
                // 根據模式初始化UI
                if (this.currentMode === GameMode.GRole) {
                    this.setupSinglePlayerUI();
                } else {
                    this.setupMultiPlayerUI();
                }
                
                // 開始主計時器
                this.startMainTimer();
                
                // 進入第一關
                this.executeNextLevel();
            }

            // 單人模式UI設置
            setupSinglePlayerUI() {
                const container = document.getElementById('game-container');
                container.innerHTML = `
                    <div class="game-ui">
                    <!-- 頂部資訊欄 -->
                    <div class="header-bar">
                        <button class="home-btn" id="home-btn">
                            返回首頁
                        </button>
                        <div class="header-info">
                            <div class="timer">總時間: <span id="main-timer">0:00</span></div>
                            <div class="score-display">分數: <span id="score">0</span></div>
                        </div>
                    </div>
                    
                    <!-- 關卡資訊區 -->
                    <div class="level-info">
                        <div class="level-title">關卡主題: <span id="current-category"></span></div>
                        <div class="level-timer"><BR>本關時間: <span id="level-timer">10</span></div>
                    </div>
                    
                    <!-- 圖片顯示區 -->
                    <div class="image-container" id="image-container"></div>
                    
                    <!-- 操作按鈕區 -->
                    <div class="action-buttons">
                        <div class="game-controls">
                            <button class="control-btn skip-btn" id="next-btn">
                                下一關
                            </button>
                            <button class="control-btn skip-btn" id="skip-btn">
                                    +1分鐘(SKIP用)
                            </button>
                        </div>
                        <div class="game-controls" style="visibility:hidden;">
                            <button class="control-btn skip-btn" id="reTime-btn">
                                    有人幫作答？(點我歸零)
                            </button>
                        </div>
                        <div class="game-actions">
                            <button class="action-btn answer-btn" id="answer-btn">
                                加 1 分
                            </button>
                        </div>
                        <div class="game-actions" style="visibility:hidden;">
                            <button class="action-btn bonus-btn" id="bonus-btn">
                                加 2 分
                            </button>
                        </div>
                    </div>
                </div>
                `;

                const bonusActionDiv = document.getElementById('bonus-btn');
                let isBonus = false;
                
                
                // 得分按鈕事件
                document.getElementById('answer-btn').addEventListener('click', () => {
                    this.score.player1 += 1;
                    document.getElementById('score').textContent = this.score.player1;
                    this.recordScoreAction('single');
                    if (this.score.player1 > 40 && isBonus == false) {
                    // 如果分數超過 40，顯示額外分數按鈕
                    bonusActionDiv.style.visibility = 'visible';
                    isBonus = true;
                    }
                });

                document.getElementById('bonus-btn').addEventListener('click', () => {
                    this.score.player1 += 2;
                    document.getElementById('score').textContent = this.score.player1;
                    this.recordScoreAction('single');
                });
                
                // 下一關按鈕事件
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.nextLevel();
                });
                // 加時間按鈕
                document.getElementById('skip-btn').addEventListener('click', () => {
                    this.mainTimer+=60;
                    document.getElementById('main-timer').textContent = this.formatDisplayTime(this.mainTimer);
                });
                
                document.getElementById('reTime-btn').addEventListener('click', () => {
                    this.levelTimer=0;
                    document.getElementById('reTime-btn').style.visibility = 'hidden';
                    document.getElementById('level-timer').textContent = levelTimer+"秒";
                });
                
                document.getElementById('home-btn').addEventListener('click', () => {
                if (confirm('確定要放棄當前遊戲返回首頁嗎？')) {
                    this.initPage();
                    }
                });

                // 初始化顯示
                this.updateLevelInfo();
            }

            // 雙人模式UI設置
            setupMultiPlayerUI() {
                const container = document.getElementById('game-container');
                container.innerHTML = `
                    <div class="game-ui multiplayer">
                        <!-- 頂部導航欄 -->
                        <div class="header-bar">
                            <button class="home-btn" id="home-btn">
                                返回首頁
                            </button>
                            <div class="timer">總時間: <span id="main-timer">0:00</span></div>
                        </div>
                        
                        <!-- 隊伍分數顯示 -->
                        <div class="team-score-display">
                            <div class="team-score red-team">
                                <div class="team-name">紅隊</div>
                                <div class="score-value" id="red-score">0</div>
                            </div>
                            <div class="team-score blue-team">
                                <div class="team-name">藍隊</div>
                                <div class="score-value" id="blue-score">0</div>
                            </div>
                        </div>
                        
                        <!-- 關卡資訊區 -->
                        <div class="level-info">
                            <div class="level-title">關卡主題: <span id="current-category"></span></div>
                            <div class="level-timer">本關目前時間: <span id="level-timer">10</span></div>
                        </div>
                        
                        <!-- 圖片顯示區 - 使用你的CSS類別 -->
                        <div class="image-container" id="image-container"></div>
                        
                        <!-- 操作按鈕區 -->
                        <div class="action-area">
                            <div class="game-controls">
                                <button class="control-btn skip-btn" id="next-btn">
                                    下一關
                                </button>
                                <button class="control-btn skip-btn" id="skip-btn">
                                    +1分鐘(SKIP用)
                                </button>
                                <!-- 解答按鈕 - 使用你定義的樣式類別 -->
                                <button class="control-btn answer-btn" id="answer-toggle-btn" style="display: none;">
                                    顯示解答
                                </button>
                            </div>
                            <div class="team-actions">
                                <button class="team-action-btn red-team" id="red-btn">
                                    紅隊得分
                                </button>
                                <button class="team-action-btn blue-team" id="blue-btn">
                                    藍隊得分
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // 設置事件監聽器
                this.setupMultiPlayerEventListeners();
            }

            // 新增：專門設置事件監聽器的方法
            setupMultiPlayerEventListeners() {
                // 解答按鈕事件
                document.getElementById('answer-toggle-btn').addEventListener('click', () => {
                    this.toggleAnswer();
                });
                
                // 紅隊得分按鈕事件 - 修正：添加 nextLevel()
                document.getElementById('red-btn').addEventListener('click', () => {
                    this.score.player1 += 1;
                    document.getElementById('red-score').textContent = this.score.player1;
                    this.recordScoreAction('red');
                });

                // 藍隊得分按鈕事件 - 修正：添加 nextLevel()
                document.getElementById('blue-btn').addEventListener('click', () => {
                    this.score.player2 += 1;
                    document.getElementById('blue-score').textContent = this.score.player2;
                    this.recordScoreAction('blue');
                });
                
                // 下一關按鈕事件
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.nextLevel();
                });
                
                // 加時間按鈕
                document.getElementById('skip-btn').addEventListener('click', () => {
                    this.mainTimer += 60;
                    document.getElementById('main-timer').textContent = this.formatDisplayTime(this.mainTimer);
                });
                
                // 返回首頁按鈕事件
                document.getElementById('home-btn').addEventListener('click', () => {
                    if (confirm('確定要結束當前遊戲返回首頁嗎？')) {
                        this.initPage();
                    }
                });
            }

            updateLevelInfo() {
                const category = this.getCurrentCategory();
                document.getElementById('current-category').textContent = this.getCategoryName(category);
                document.getElementById('level-timer').textContent = this.levelTimer;
            }

            // 開始主計時器
            startMainTimer() {
                // 清除現有計時器
                if (this.mainTimerInterval) {
                    clearInterval(this.mainTimerInterval);
                }
                
                this.mainTimerInterval = setInterval(() => {
                    this.mainTimer += 1;
                    document.getElementById('main-timer').textContent = this.formatDisplayTime(this.mainTimer);
                    
                    // 檢查遊戲結束條件
                    if ((this.currentMode === GameMode.GRole && this.mainTimer >= 720) || // 12分鐘
                        (this.currentMode === GameMode.GBrand && this.mainTimer >= 1140)) { // 19分鐘
                        this.endGame();
                    }
                }, 1000);
            }

            formatDisplayTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // 下一關
            nextLevel() {
                // 檢查鎖定模式並確認是否跳關
                if (this.lockMode && !this.checkScoreAdded()) {
                    this.showSkipConfirmation();
                    return; // 不執行跳關
                }
                
                // 正常執行跳關邏輯
                this.executeNextLevel();
            }

            executeNextLevel() {
                this.showAnswerMode = false;
                this.updateAnswerButton();

                clearTimeout(this.levelTimeout);
                clearInterval(this.levelTimerInterval);
                
                const category = this.getCurrentCategory();
                this.level++;
                this.currentQuestionPath = this.getRandomImage(category);
                this.showLevelImage(category);
                this.startLevelTimer();
                this.updateLevelInfo();
                document.getElementById('reTime-btn').style.visibility = 'hidden';


                this.checkAndEnableAnswerButton(category);
                
                // 重置最後操作記錄
                this.lastAction = null;
            }

            // 檢查是否已加分
                checkScoreAdded() {
                    const currentTime = Date.now();
                    
                    // 如果在最近3秒內有加分操作，認為已加分
                    if (this.lastAction === 'score' && (currentTime - this.lastActionTime) < 3000) {
                        return true;
                    }
                    
                    // 檢查分數是否有變化（比較複雜，需要記錄上一個狀態）
                    return false;
                }

                showSkipConfirmation() {
                    // 創建自定義確認對話框
                    const confirmDialog = document.createElement('div');
                    confirmDialog.className = 'skip-confirm-dialog';
                    confirmDialog.innerHTML = `
                        <div class="confirm-content">
                            <h3>⚠️ 確認跳關</h3>
                            <p>您尚未為任何隊伍加分，確定要跳過本關嗎？</p>
                            <div class="confirm-buttons">
                                <button class="confirm-btn cancel-btn">取消</button>
                                <button class="confirm-btn continue-btn">繼續跳關</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(confirmDialog);
                    
                    // 按鈕事件
                    confirmDialog.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(confirmDialog);
                    });
                    
                    confirmDialog.querySelector('.continue-btn').addEventListener('click', () => {
                        document.body.removeChild(confirmDialog);
                        this.executeNextLevel();
                    });
                    
                }

                // 記錄加分操作
                recordScoreAction(team) {
                    this.lastAction = 'score';
                    this.lastActionTime = Date.now();
                    console.log(`${team === 'red' ? '紅隊' : '藍隊'} 加分，時間: ${new Date().toLocaleTimeString()}`);
                }



             getCategoryName(category) {
                const names = {
                    [GameCategory.GUESS_CHARACTER]: '照片猜人物',
                    [GameCategory.GUESS_CHARACTER_CROPPED]: '擷取照片猜人物',
                    [GameCategory.GUESS_CHARACTER_SCENE]: '場景猜人物',
                    [GameCategory.GUESS_WORK_BY_CHARACTER]: '人物猜作品',
                    [GameCategory.GUESS_BRAND]: '猜品牌',
                    [GameCategory.GUESS_ORIGINAL_BRAND]: '猜正版品牌',
                    [GameCategory.GUESS_PARENT_BRAND]: '子品牌猜源品牌',
                    [GameCategory.FIND_BRAND_DIFFERENCE]: '品牌猜不同'
                };
                return names[category] || '未知主題';
            }

            condition(mainTime,score){
                if(this.currentMode === GameMode.GRole){
                    return ((this.mainTimer < mainTime) && (this.score.player1 < score))?true:false;
                }
                else
                {
                    return ((this.mainTimer < mainTime))?true:false;
                }
            }

            // 從路徑獲取分類
            getCategoryFromPath(imagePath) {
                // 根據您的路徑結構來解析分類
                // 例如: /images/game/猜人物/照片猜人物/rick.jpg → 猜人物/照片猜人物
                const pathParts = imagePath.split('/');
                const gameIndex = pathParts.indexOf('game');
                
                if (gameIndex !== -1 && pathParts.length > gameIndex + 2) {
                    return pathParts.slice(gameIndex + 1, gameIndex + 3).join('/');
                }
                
                return null;
            }

            // 獲取當前題目類別
             getCurrentCategory() {
                if (this.currentMode === GameMode.GRole) {
                    if (this.condition(360,21))
                        return GameCategory.GUESS_CHARACTER; // 6分鐘
                    else if (this.condition(540,31))
                        return GameCategory.GUESS_CHARACTER_CROPPED; // 9分鐘和30分
                    else if (this.condition(720,41))
                        return GameCategory.GUESS_CHARACTER_SCENE; // 12分鐘和40分
                    else
                        return GameCategory.GUESS_WORK_BY_CHARACTER; // 45分
                } else {
                    if (this.condition(420,'none')) return GameCategory.GUESS_BRAND; // 7分鐘
                    else if (this.condition(840,'none') ) return GameCategory.GUESS_ORIGINAL_BRAND; // 14分鐘
                    else if (this.condition(1020,'none')) return GameCategory.GUESS_PARENT_BRAND; // 17分鐘
                    return GameCategory.FIND_BRAND_DIFFERENCE;
                }
                
                return GameCategory.GUESS_CHARACTER;
            }            

            // 更新解答按鈕狀態
            updateAnswerButton() {
                const answerBtn = document.getElementById('answer-toggle-btn');
                if (answerBtn && this.answerButtonEnabled) {
                    if (this.showAnswerMode) {
                        answerBtn.textContent = '返回題目';
                        answerBtn.classList.add('active');
                    } else {
                        answerBtn.textContent = '顯示解答';
                        answerBtn.classList.remove('active');
                    }
                    console.log('按鈕文字更新為:', answerBtn.textContent);
                }
            }

            // 在適當的時機啟用解答按鈕（例如：特定關卡或時間）
            enableAnswerButton(enable) {
                const answerBtn = document.getElementById('answer-toggle-btn'); // 修正ID
                if (answerBtn) {
                    this.answerButtonEnabled = enable;
                    answerBtn.style.display = enable ? 'block' : 'none';
                    
                    if (!enable) {
                        this.showAnswerMode = false;
                        this.showQuestionImage();
                    }
                }
            }

            // 檢查並啟用解答按鈕
            checkAndEnableAnswerButton(category) {
                // 只在特定關卡類型啟用解答按鈕
                const answerEnabledCategories = [
                    GameCategory.GUESS_ORIGINAL_BRAND,
                    GameCategory.GUESS_PARENT_BRAND,
                    GameCategory.FIND_BRAND_DIFFERENCE
                ];
                
                const enableAnswer = answerEnabledCategories.includes(category);
                this.enableAnswerButton(enableAnswer);
            }

            // 切換解答顯示
            toggleAnswer() {
                if (!this.answerButtonEnabled) {
                    console.log('解答按鈕未啟用');
                    return;
                }
                
                console.log('切換前狀態:', this.showAnswerMode ? '解答模式' : '題目模式');
                
                // 切換狀態
                this.showAnswerMode = !this.showAnswerMode;
                
                // 根據狀態顯示內容
                if (this.showAnswerMode) {
                    this.showAnswerImage();
                } else {
                    this.showQuestionImage();
                }
                
                // 更新按鈕
                this.updateAnswerButton();
                
                console.log('切換後狀態:', this.showAnswerMode ? '解答模式' : '題目模式');
            }

            // 顯示解答圖片
           async showAnswerImage() {
                const imageContainer = document.getElementById('image-container');
                
                console.log('嘗試顯示解答，當前題目路徑:', this.currentQuestionPath);
                
                try {
                    const answerPath = this.getAnswerPath(this.currentQuestionPath);
                    
                    if (answerPath) {
                        console.log('準備載入解答圖片:', answerPath);
                        
                        // 預載解答圖片
                        await this.preloadImage(answerPath);
                        
                        // 完全按照你的CSS結構 - 圖片 + 絕對定位的標籤
                        imageContainer.innerHTML = `
                            <img src="${answerPath}" 
                                alt="解答圖片" 
                                onerror="this.src='${this.getDefaultImage()}';">
                            <div style="position: absolute; top: 10px; left: 10px; background: #4CAF50; color: white; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                解答
                            </div>
                        `;
                        
                        console.log('解答圖片顯示成功');
                        
                    } else {
                        console.log('沒有找到解答圖片');
                        // 保持容器結構，只是顯示文字訊息
                        imageContainer.innerHTML = `
                            <div class="no-answer">本題目沒有提供解答圖片</div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('載入解答失敗:', error);
                    imageContainer.innerHTML = `
                        <div class="error">載入解答時發生錯誤</div>
                    `;
                }
            }

            debugAnswerSystem() {
                console.log('=== 解答系統除錯資訊 ===');
                console.log('當前題目路徑:', this.currentQuestionPath);
                console.log('當前分類:', this.getCurrentCategory());
                console.log('對應資料夾:', this.categoryFolders[this.getCurrentCategory()]);
                
                const folder = this.categoryFolders[this.getCurrentCategory()];
                if (folder && this.imageList[folder]) {
                    console.log('資料夾內容:', this.imageList[folder]);
                    
                    if (this.imageList[folder].answers) {
                        console.log('可用解答:', Object.keys(this.imageList[folder].answers));
                    } else {
                        console.log('該資料夾沒有解答');
                    }
                } else {
                    console.log('找不到資料夾或資料夾內容');
                }
                
                // 測試路徑解析
                if (this.currentQuestionPath) {
                    const extension = getExtension(this.currentQuestionPath);
                    const fileName = getBasename(this.currentQuestionPath, extension);
                    console.log('解析結果 - 副檔名:', extension, '檔名:', fileName);
                    
                    const answerPath = this.getAnswerPath(this.currentQuestionPath);
                    console.log('解答路徑:', answerPath);
                }
                console.log('========================');
            }

            // 顯示題目圖片
            showQuestionImage() {
                const imageContainer = document.getElementById('image-container');
                const category = this.getCurrentCategory();
                
                // 直接放圖片，符合你的CSS結構
                imageContainer.innerHTML = `
                    <img src="${this.currentQuestionPath}" 
                        alt="${this.getCategoryName(category)}" 
                        onerror="this.src='${this.getDefaultImage()}';">
                `;
                
                console.log('顯示題目圖片:', this.currentQuestionPath);
            }

             getAnswerPath(questionPath) {
                try {
                    console.log('開始尋找解答圖片，題目路徑:', questionPath);
                    
                    // 使用瀏覽器相容的方式獲取檔案名稱
                    const extension = getExtension(questionPath);
                    const fileName = getBasename(questionPath, extension);
                    
                    console.log('提取的檔案名稱:', fileName);
                    
                    // 獲取當前分類對應的資料夾
                    const currentCategory = this.getCurrentCategory();
                    const folder = this.categoryFolders[currentCategory];
                    
                    console.log('當前分類:', currentCategory);
                    console.log('對應資料夾:', folder);
                    
                    // 檢查該資料夾是否有解答
                    if (!folder || !this.imageList[folder]) {
                        console.warn('找不到對應的資料夾:', folder);
                        return null;
                    }
                    
                    const folderData = this.imageList[folder];
                    console.log('資料夾內容:', folderData);
                    
                    // 檢查是否有 answers 物件
                    if (!folderData.answers || typeof folderData.answers !== 'object') {
                        console.warn('該資料夾沒有解答圖片');
                        return null;
                    }
                    
                    // 尋找對應的解答
                    const answerPath = this.getBasePath()+'/' + folderData.answers[fileName];
                    console.log('找到的解答路徑:', answerPath);
                    
                    if (!answerPath) {
                        console.warn(`找不到檔案 ${fileName} 的解答`);
                        console.log('可用的解答列表:', Object.keys(folderData.answers));
                        return null;
                    }
                    
                    return answerPath;
                    
                } catch (error) {
                    console.error('獲取解答路徑時發生錯誤:', error);
                    return null;
                }
            }
                    

            // 顯示關卡圖片
            async showLevelImage(category) {
                const imageContainer = document.getElementById('image-container');
                
                // 載入提示 - 使用你CSS中定義的loading樣式
                imageContainer.innerHTML = '<div class="loading">載入中...</div>';
                
                try {
                    const imagePath = this.getRandomImage(category);
                    this.currentQuestionPath = imagePath; // 設置當前問題路徑
                    
                    console.log('嘗試載入圖片:', imagePath);
                    
                    // 預載圖片
                    await this.preloadImage(imagePath);
                    
                    // 顯示圖片 - 直接放img標籤
                    imageContainer.innerHTML = `
                        <img src="${imagePath}" 
                            alt="${this.getCategoryName(category)}" 
                            onerror="this.src='${this.getDefaultImage()}';">
                    `;
                    
                    console.log('圖片顯示成功');
                    
                } catch (error) {
                    console.error('顯示圖片失敗:', error);
                    
                    // 錯誤顯示 - 使用你CSS中定義的error樣式
                    imageContainer.innerHTML = `
                        <div class="error">圖片載入失敗</div>
                        <img src="${this.getDefaultImage()}" alt="預設圖片">
                    `;
                }
            }

            // 開始關卡計時器
            startLevelTimer() {
                this.levelTimer = 0;
                clearTimeout(this.levelTimeout);
                
                // 更新本關時間顯示
                const updateLevelTimer = () => {
                    this.levelTimer += 1;
                    var iSretime =false;
                    const reTimeBTN = document.getElementById('reTime-btn');

                    if(this.levelTimer<=10){
                        document.getElementById('level-timer').textContent = this.levelTimer+"秒";
                        if(iSretime==true){reTimeBTN.style.visibility = 'hidden';iSretime=false}
                    }
                    else{
                        document.getElementById('level-timer').textContent = this.levelTimer+"秒  時間到";
                        if(iSretime==false){reTimeBTN.style.visibility = 'visible';iSretime=true}
                    }
                };
                
                // 每秒更新本關時間
                this.levelTimerInterval = setInterval(updateLevelTimer, 1000);
            }

            // 結束遊戲
            endGame() {
                this.state = GameState.END;
                clearInterval(this.mainTimerInterval);
                clearTimeout(this.levelTimeout);
                
                // 顯示結束頁面
                this.showEndPage();
            }

            // 顯示結束頁面
            showEndPage() {
                const container = document.getElementById('game-container');
                if (this.currentMode === GameMode.GRole) {
                    container.innerHTML = `
                        <div class="end-screen">
                            <h2>遊戲結束</h2>
                            <p>你的分數: ${this.score.player1}</p>
                            <button id="restart-btn">再玩一次</button>
                            <button id="home-btn">返回首頁</button>
                        </div>
                    `;
                } else {
                    const winner = this.score.player1 > this.score.player2 ? "紅隊" : 
                                 this.score.player1 < this.score.player2 ? "藍隊" : "平局";
                    
                    container.innerHTML = `
                        <div class="end-screen">
                            <h2>遊戲結束</h2>
                            <p>紅隊分數: ${this.score.player1}</p>
                            <p>藍隊分數: ${this.score.player2}</p>
                            <p style="font-weight: bold; font-size: 28px;">${winner}獲勝!</p>
                            <button id="restart-btn">再玩一次</button>
                            <button id="home-btn">返回首頁</button>
                        </div>
                    `;
                }
                
                document.getElementById('restart-btn').addEventListener('click', () => {
                    this.startGame();
                });
                
                document.getElementById('home-btn').addEventListener('click', () => {
                    this.initPage();
                });
            }
        }

        // 初始化遊戲
        document.addEventListener('DOMContentLoaded', () => {
            const game = new Game();
        });
    </script>
</body>
</html>
